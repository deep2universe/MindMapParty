<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PartyRock Mindmap</title>
    <style>
        svg.markmap {
            width: 100%;
            height: 100vh;
        }
    </style>
    <style>
        svg.markmap {
            width: 100%;
            height: 100vh;
        }

        #inputForm {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="markmap">
</div>
<div id="inputForm" style="display:none;">
    <h2>Create Your Mindmap</h2>
    <p>Enter your markdown content from <b>PartyRock</b> below:</p>
    <form id="markdownForm">
        <textarea id="markdownText" style="width:100%; height:580px; overflow:auto;"></textarea>
        <br>
        <input type="submit" value="Generate Mindmap">
    </form>
</div>
</body>
<script>
    document.getElementById('markdownForm').onsubmit = function (event) {
        event.preventDefault();
        const text = document.getElementById('markdownText').value;
        const base64Encoded = btoa(text);
        window.location.search = '?base64=' + base64Encoded;
    };

    function getBase64Param() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('base64');
    }

    const base64String = getBase64Param();
    if (base64String) {
        let markdownContent = atob(base64String)
            .replace(/<content-for-base64>/g, '')
            .replace(/<\/content-for-base64>/g, '')
            .replace(/[\s\S]*?(# [a-zA-Z0-9 ]+)/, '$1');
        // Remove leading spaces from the first line
        markdownContent = markdownContent.replace(/^\s+/, '');

        // Add newline before each "#", "-", "##", "###", "####" if no newline is present
        markdownContent = markdownContent.replace(/(?<!\n)(#|##|###|####|-)/g, '\n$1');

        let lines = markdownContent.split('\n').filter(line => !line.match(/^(\*{1,2}|-|#)\s*$/));
        lines = lines.filter(line => line.trim() !== '');
        markdownContent = lines.map((line, index) => {
            if (index === 0 && !line.startsWith('# ')) {
                return `# ${line}`;
            } else if (line.startsWith('*')) {
                return `- ${line.substring(1)}`;
            } else {
                return /^[A-Za-z]/.test(line) ? `## ${line}` : line;
            }
            line = line.replace(/<h1>/gi, '# ').replace(/<\/h1>/gi, '').replace(/\[\*/g, '*').replace(/\*\]/g, '*');
        }).join('\n');

        function ensureMarkdownStructure(markdownLines) {
            // This function adjusts the structure of the markdown content.
            // It ensures the first heading starts with "# " and subsequent headings are converted to subtopics with "## ".
            // It also prepends "- " to lines starting with a letter or number that are not already part of a list or heading.
            let hasMainTopic = false;
            return markdownLines.map(line => {
                if (line.startsWith('# ') && !hasMainTopic) {
                    hasMainTopic = true; // First main topic
                    return line;
                } else if (line.startsWith('# ')) {
                    return `## ${line.substring(2)}`; // Convert to subtopic
                } else if (/^[A-Za-z0-9]/.test(line)) { // This regex checks if a line starts with a letter or number and prepends "- " to the line
                    return `- ${line}`;
                }
                return line;
            });
        }

        markdownContent = ensureMarkdownStructure(lines).join('\n');

        if (!markdownContent.startsWith('#')) {
            markdownContent = "# --->\n" + markdownContent;
        }

        const markmapFrontmatter = "---\nmarkmap:\n  maxWidth: 380\n  colorFreezeLevel: 2\n---\n";
        markdownContent = markmapFrontmatter + markdownContent;

        markdownContent = markdownContent.replace(/\*\*\s/g, '**') // regex replaces "** " with "**" to correct bold markdown syntax
            .replace(/(^|\n)#([^\s])/g, '$1# $2') // regex ensures that there is a space after "#" in headings
            .replace(/# #/g, '##');// replaces "# #" with "##" to correct heading level 2 markdown syntax

        const scriptElement = document.createElement('script');
        scriptElement.type = 'text/template';
        scriptElement.textContent = markdownContent;
        const markmap_div = document.getElementsByClassName("markmap");
        markmap_div[0].appendChild(scriptElement);
    } else {
        document.getElementById('inputForm').style.display = 'block';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16"></script>
</html>
